"use strict";function getFileData(a,b,c,d){var e="GET";!c||c!=="POST".toLowerCase()&&c!=="GET".toLowerCase()||(e=c);var f=new XMLHttpRequest;f.open(e,a,!0),d&&(f.responseType=d),f.onreadystatechange=function(){4===f.readyState&&200===f.status?"function"==typeof b&&b("json"!==d?f.responseText:f.response):4===f.readyState&&f.status>400&&"function"==typeof b&&b("{}")},f.send()}function compareVersion(a,b){if(a===b)return 0;for(var c=a.split("."),d=b.split("."),e=Math.min(c.length,d.length),f=0;f<e;f++){if(parseInt(c[f])>parseInt(d[f]))return 1;if(parseInt(c[f])<parseInt(d[f]))return-1}return c.length>d.length?1:c.length<d.length?-1:0}function postFileData(a,b,c){var d="",e=!1;Object.keys(b).forEach(function(a){e?d+="&":e=!0,d+=encodeURIComponent(a).replace(/%20/g,"+")+"="+encodeURIComponent(b[a]).replace(/%20/g,"+")});var f=new XMLHttpRequest;f.open("POST",a,!0),f.setRequestHeader("Content-type","application/x-www-form-urlencoded"),f.onreadystatechange=function(){4===f.readyState&&200===f.status&&"function"==typeof c&&c(f.responseText)},f.send(d)}function searchBilibili(a){chrome.tabs.create({url:protocol+"search.bilibili.com/all?keyword="+encodeURIComponent(a.selectionText)})}function notifyAllTabs(a){chrome.windows.getAll({populate:!0},function(b){b.forEach(function(b){b.tabs.forEach(function(b){chrome.tabs.sendMessage(b.id,a)})})})}function updateAll(){notifyAllTabs({command:"update"})}function enableAll(){setOption("enabled",!0),updateAll()}function disableAll(){setOption("enabled",!1),updateAll()}function checkDynamic(){"on"===getOption("dynamic")&&hasLogin===!0&&getFileData(protocol+"api.bilibili.com/x/feed/unread/count?type=0",function(a){var b=JSON.parse(a);"object"===("undefined"==typeof b?"undefined":_typeof(b))&&0===b.code&&"object"===_typeof(b.data)&&"number"==typeof b.data.all&&(b.data.all>0?(setOption("updates",b.data.all),chrome.browserAction.setBadgeText({text:getOption("updates")}),getFileData(protocol+"api.bilibili.com/x/feed/pull?ps=1&type=0",function(a){var c=JSON.parse(a);if("object"===("undefined"==typeof c?"undefined":_typeof(c))&&0===c.code&&"object"===_typeof(c.data)&&"object"===_typeof(c.data.feeds)&&c.data.feeds.length>0){var d=c.data.feeds[0];if(d.ctime!==parseInt(getOption("lastDyn"))){notification&&chrome.notifications.clear("bh-"+notification,function(){}),notification=d.ctime;var e=chrome.i18n.getMessage("followingUpdateMessage").replace("%n",b.data.all).replace("%uploader",d.source.uname||d.addition.author).replace("%title",d.addition.title),f=d.addition.pic?d.addition.pic:"imgs/icon-256.png";notificationAvid["bh-"+notification]=d.addition.aid,chrome.notifications.create("bh-"+notification,{type:"basic",iconUrl:f,title:chrome.i18n.getMessage("noticeficationTitle"),message:e,isClickable:!1,buttons:[{title:chrome.i18n.getMessage("notificationWatch")}]},function(){}),setOption("lastDyn",d.ctime)}}})):(setOption("updates",0),chrome.browserAction.setBadgeText({text:""})))})}function resolvePlaybackLink(a,b){if(!(a&&a.durl&&a.durl[0]&&a.durl[0].url))return"function"==typeof b&&b(a),!1;var c=new XMLHttpRequest,d=function f(){if(2===c.readyState){e||200===c.status||(e=!0,c.abort(),c=new XMLHttpRequest,c.open("GET",a.durl[0].url,!0),c.onreadystatechange=f,c.send());var d=c.responseURL||a.durl[0].url,g=new URL(d).origin+"/*";videoPlaybackHosts.indexOf(g)<0&&(videoPlaybackHosts.push(g),resetVideoHostList()),a.durl[0].url=d,"function"==typeof b&&b(a),c.abort()}},e=!1;c.open("HEAD",a.durl[0].url,!0),c.onreadystatechange=d,c.send()}function getVideoInfo(a,b,c){b=parseInt(b);var d=parseInt((new Date).getTime()/1e3);return(isNaN(b)||b<1)&&(b=1),"undefined"!=typeof viCache[a+"-"+b]&&d-viCache[a+"-"+b].ts<=3600?(c(viCache[a+"-"+b]),!0):(resetVideoHostList(),getFileData(protocol+"api.bilibili.com/view?type=json&appkey=8e9fc618fbd41e28&id="+a+"&page="+b+"&batch=true",function(e){if(e=JSON.parse(e),"undefined"!=typeof e.code&&e.code===-503)setTimeout(function(){getVideoInfo(a,b,c)},1e3);else{if("object"===_typeof(e.list)){e.pages=e.list.length;for(var f=0;f<e.pages;f++)if(e.list[f].page===b){e.cid=e.list[f].cid;break}}"number"==typeof e.cid?(viCache[a+"-"+b]={mid:e.mid,tid:e.tid,cid:e.cid,pic:e.pic,pages:e.pages,title:e.title,list:e.list,sp_title:e.sp_title,spid:e.spid,season_id:e.season_id,created_at:e.created_at,description:e.description,tag:e.tag,ts:d,bangumi:!1},"object"===_typeof(e.bangumi)?getFileData(protocol+"api.bilibili.cn/sp?spid="+e.spid,function(d){d=JSON.parse(d),1===d.isbangumi&&(viCache[a+"-"+b].bangumi={cover:d.cover,desc:d.description}),c(viCache[a+"-"+b])}):c(viCache[a+"-"+b])):c(e)}}),!0)}function checkSecurePlayer(){var a=new XMLHttpRequest;a.open("HEAD",protocol+"static-s.bilibili.com/play.swf",!0),a.onreadystatechange=function(){4===a.readyState&&200===a.status&&(secureAvailable="application/x-shockwave-flash"===a.getResponseHeader("Content-Type"))},a.send()}function setTreasure(a){if("[object Object]"===Object.prototype.toString.call(a))for(var b in a)({}).hasOwnProperty.call(a,b)&&(Live.treasure[b]=a[b])}function setWatcherRoom(a){if("[object Object]"===Object.prototype.toString.call(a))for(var b in a)({}).hasOwnProperty.call(a,b)&&(Live.watcherRoom[b]=a[b])}function setFavourite(a){return Live.favouritesIdList.indexOf(a.roomId)===-1&&(Live.favouritesIdList.push(a.roomId),Live.favouritesList[a.roomId]=a,Live.set("favouritesIdList",Live.favouritesIdList),Live.set("favouritesList",Live.favouritesList),!0)}function setNotFavourite(a){var b=Live.favouritesIdList.indexOf(a);return b!==-1&&(Live.favouritesIdList.splice(b,1),delete Live.favouritesList[a],Live.set("favouritesIdList",Live.favouritesIdList),Live.set("favouritesList",Live.favouritesList),!0)}function checkVersion(){var a=getOption("versionNotify");"on"===a&&getFileData(protocol+"bilihelper.guguke.net/version.json?v="+encodeURIComponent(chrome.runtime.getManifest().version),function(a){try{a=JSON.parse(a),compareVersion(a.version,chrome.runtime.getManifest().version)>0&&(setOption("crx_update",JSON.stringify(a)),(!localeAcquired||1===locale||(new Date).getTime()-a.update_time>2592e5)&&(updateNotified=!0,chrome.tabs.create({url:chrome.extension.getURL("options.html?mod=new")})))}catch(b){console.error("Failed to check version",b)}})}function receivedHeaderModifier(a){var b=!1;return a.responseHeaders.forEach(function(a){"access-control-allow-origin"===a.name.toLowerCase()&&(b=!0)}),b?b||bangumi?b||a.responseHeaders.push({name:"Access-Control-Allow-Origin",value:protocol+"bangumi.bilibili.com"}):a.responseHeaders.push({name:"Access-Control-Allow-Origin",value:protocol+"www.bilibili.com"}):(a.responseHeaders.push({name:"Access-Control-Allow-Credentials",value:"true"}),a.responseHeaders.push({name:"Access-Control-Allow-Methods",value:"POST, GET"}),a.responseHeaders.push({name:"Access-Control-Allow-Origin",value:protocol+"www.bilibili.com"})),{responseHeaders:a.responseHeaders}}function resetVideoHostList(){chrome.webRequest.onHeadersReceived.hasListener(receivedHeaderModifier)&&chrome.webRequest.onHeadersReceived.removeListener(receivedHeaderModifier),chrome.webRequest.onHeadersReceived.addListener(receivedHeaderModifier,{urls:videoPlaybackHosts},["responseHeaders","blocking"])}function getCookie(a){var b=void 0,c=new RegExp("(^| )"+a+"=([^;]*)(;|$)");return(b=document.cookie.match(c))?unescape(b[2]):null}function each(a,b){if(b)if(a instanceof Array)for(var c=0,d=a.length;c<d&&b.call(a[c],c)!==!1;c++);else if("object"===("undefined"==typeof a?"undefined":_typeof(a))){var e=null;for(e in a)if(b.call(a[e],e)===!1)break}}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},notification=!1,notificationAvid={},downloadNames={},playerTabs={},viCache={},locale=0,localeAcquired=!1,localeTimeout=null,secureAvailable=!1,biliTabs={},updateNotified=!1,protocol="https://",videoPlaybackHosts=[protocol+"*.hdslb.com/*",protocol+"*.acgvideo.com/*"],Live={},bangumi=!1,DedeUserID=null,hasLogin=!1,subName="",crcEngine=null,refererList={},parsedDataList={},PLAY_URLS=["*://bangumi.bilibili.com/player/web_api/playurl*","*://bangumi.bilibili.com/player/web_api/v2/playurl*","*://interface.bilibili.com/playurl*","*://interface.bilibili.com/v2/playurl*"];Live.set=function(a,b,c){if(window.localStorage&&a){var d=window.localStorage;d[a]||(d[a]=JSON.stringify({}));var e=JSON.parse(d[a]);void 0===c?d[a]="string"==typeof b?b.trim():JSON.stringify(b):(e[b]="string"==typeof c?c.trim():JSON.stringify(c),d[a]=JSON.stringify(e))}},Live.get=function(a,b,c){if(window.localStorage&&a){if(!window.localStorage[a]){var d=void 0===c?{}:c;void 0!==b&&void 0!==c&&(d[b]=c),window.localStorage[a]=JSON.stringify(d)}var e=JSON.parse(window.localStorage[a]);return void 0===b?e:("true"!==e[b]&&"false"!==e[b]||(e[b]=JSON.parse(e[b])),e[b])}},Live.del=function(a,b){if(window.localStorage&&void 0!==a&&void 0!==window.localStorage[a]){if(void 0===b)return void window.localStorage.removeItem(a);var c=JSON.parse(window.localStorage[a]);delete c[b],window.localStorage[a]=JSON.stringify(c)}},Live.notisesIdList={},Live.favouritesIdList=Live.get("favouritesIdList",void 0,[]),Live.favouritesList=Live.get("favouritesList",void 0,{}),URL.prototype.__defineGetter__("query",function(){var a=this.search.substr(1).split("&"),b={};return a.forEach(function(a,c,d){var e=d[c].split("=");b[e[0]]=e[1]}),b}),chrome.cookies.get({url:"https://www.bilibili.com",name:"bili_jct"},function(a){a&&(hasLogin=!0)}),"function"==typeof chrome.runtime.setUninstallURL&&chrome.runtime.setUninstallURL(protocol+"extlabs.io/analytics/uninstall/?uid=178&pid=264&finish_url=https%3A%2F%2Fbilihelper.guguke.net%2F%3Funinstall%26version%3D"+chrome.runtime.getManifest().version),Live.treasure={},Live.watcherRoom={},Live.tvs={},Live.tvNotification={},chrome.runtime.onConnect.addListener(function(a){Live.treasure.port=a}),chrome.runtime.onMessage.addListener(function(a,b,c){switch(a.command){case"init":return biliTabs[b.tab.id]=a.cid,c({autowide:getOption("autowide"),version:version,macplayer:getOption("macplayer"),autooffset:getOption("autooffset")}),!0;case"cidHack":return!isNaN(a.cid)&&(playerTabs[b.tab.id]=a.cid,c(),!0);case"getOption":return c({value:getOption(a.key)}),!0;case"getAd":return c({value:getOption("ad")}),!0;case"setOption":return setOption(a.key,a.value),c({value:getOption(a.key)}),!0;case"getTreasure":return c({data:Live.treasure}),!0;case"setTreasure":return setTreasure(a.data),c({data:Live.treasure}),!0;case"setCurrentTreasure":return void 0!==a.data.time_end&&a.data.time_end!==Live.treasure.time_end&&Live.treasure.port&&(setTreasure(a.data),Live.treasure.port.postMessage({command:"updateCurrentTreasure",data:{minute:a.data.minute,silver:a.data.silver,time_end:a.data.time_end,time_start:a.data.time_start}})),!0;case"getCurrentTreasure":return c({data:{minute:Live.treasure.minute,silver:Live.treasure.silver,time_end:Live.treasure.time_end,time_start:Live.treasure.time_start}}),!0;case"delTreasure":return c({data:Live.treasure={}}),!0;case"getWatcherRoom":return c({data:Live.watcherRoom}),!0;case"setWatcherRoom":return setWatcherRoom(a.data),c({data:Live.watcherRoom}),!0;case"delWatcherRoom":return c({data:Live.watcherRoom={}}),!0;case"setFavourite":return c({data:setFavourite(a.upInfo)}),!0;case"setNotFavourite":return c({data:setNotFavourite(a.id)}),!0;case"getFavourite":return c({data:Live.get("favouritesIdList")}),!0;case"enableAll":return enableAll(),c({result:"ok"}),!0;case"disableAll":return disableAll(),c({result:"ok"}),!0;case"getCSS":return c("true"===getOption("enabled")||"keep"!==getOption("ad")?{result:"ok",css:getCSS(a.url)}:{result:"disabled"}),!0;case"getVideoInfo":return getVideoInfo(a.avid,a.pg,function(a){c({videoInfo:a})}),!0;case"getMyInfo":return getFileData(protocol+"api.bilibili.com/myinfo",function(a){a=JSON.parse(a),void 0===_typeof(a.code)&&(a.code=200),c({code:a.code||200,myinfo:a})}),!0;case"getBangumiInfo":var d=a.episodeId;return getFileData(protocol+"bangumi.bilibili.com/web_api/episode/"+d+".json",function(a){a=JSON.parse(a),void 0===_typeof(a.code)&&(a.code=200),a=a.result,c({videoInfo:a.currentEpisode})}),!0;case"searchVideo":var e=a.keyword;return getFileData(protocol+"api.bilibili.com/search?type=json&appkey=8e9fc618fbd41e28&keyword="+encodeURIComponent(e)+"&page=1&order=ranklevel",function(a){a=JSON.parse(a),c(0===a.code?{status:"ok",result:a.result[0]}:{status:"error",code:a.code,error:a.error})}),!0;case"checkComment":return getFileData(protocol+"www.bilibili.com/feedback/arc-"+a.avid+"-1.html",function(a){var b=a.indexOf('<div class="no_more">');c(b>=0?{banned:!0}:{banned:!1})}),!0;case"savePlayerConfig":return c({result:setOption("playerConfig",JSON.stringify(a.config))}),!0;case"sendComment":var f=["正常","选择的弹幕模式错误","用户被禁止","系统禁止","投稿不存在","UP主禁止","权限有误","视频未审核/未发布","禁止游客弹幕"];return a.comment.cid=a.cid,postFileData(protocol+"interface.bilibili.com/dmpost?cid="+a.cid+"&aid="+a.avid+"&pid="+a.page,a.comment,function(a){a=parseInt(a),c(a<0?{result:!1,error:f[-a]}:{result:!0,id:a})}),!0;case"tvNotification":var g=a.data,h=g.roomId;return Live.tvNotification[h]=!0,chrome.notifications.create(h,{type:"basic",iconUrl:protocol+"static.hdslb.com/live-static/live-room/images/gift-section/gift-25.gif",title:"小电视抽奖提示",message:"直播间【"+h+"】正在进行小电视抽奖",isClickable:!0,buttons:[{title:chrome.i18n.getMessage("notificationGetTv")}]},function(a){setTimeout(function(){chrome.notifications.clear(a)},1e4)}),!0;case"getTVReward":var i="",j="很遗憾，此次您没有中奖",k=a.data;return i+=1===k.rewardId?"大号小电视"+k.rewardNum+"个":2===k.rewardId?"蓝白胖次道具"+k.rewardNum+"个":3===k.rewardId?"B坷垃"+k.rewardNum+"个":4===k.rewardId?"喵娘"+k.rewardNum+"个":5===k.rewardId?"便当"+k.rewardNum+"个":6===k.rewardId?"银瓜子"+k.rewardNum+"个":7===k.rewardId?"辣条"+k.rewardNum+"个":j,k.rewardNum>0?1===k.rewardId||k.isWin?chrome.notifications.create("getTV",{type:"basic",iconUrl:protocol+"static.hdslb.com/live-static/live-room/images/gift-section/gift-25.png",title:"小电视抽奖结果",message:"恭喜你抽到了小电视，请尽快前往填写收货地址，不填视为放弃",isClickable:!1,buttons:[{title:chrome.i18n.getMessage("notificationGetTv")}]},function(a){setTimeout(function(){chrome.notifications.clear(a)},1e4)}):chrome.notifications.create("getTV",{type:"basic",iconUrl:protocol+"static.hdslb.com/live-static/live-room/images/gift-section/gift-25.png",title:"小电视抽奖结果",isClickable:!1,message:"在直播间:"+k.roomId+" 抽到"+i},function(a){setTimeout(function(){chrome.notifications.clear(a)},1e4)}):chrome.notifications.create("getTV",{type:"basic",iconUrl:protocol+"static.hdslb.com/live-static/live-room/images/gift-section/gift-25.png",title:"直播间:"+k.roomId,message:i,isClickable:!1},function(a){setTimeout(function(){chrome.notifications.clear(a)},1e4)}),!0;case"requestForDownload":return chrome.downloads.download({saveAs:!0,url:a.data?URL.createObjectURL(new Blob([a.data],{type:"application/octet-stream"})):a.url,filename:a.filename}),!0;case"callBilibiliMac":return postFileData("http://localhost:23330/rpc",a.data,function(){c(!0)}),!0;case"suggestName":return downloadNames[a.url.split("?")[0]]=a.filename,c(),!1;case"uidLookup":return crcEngine||(crcEngine=new Crc32Engine),c({uids:crcEngine.crack(a.user)}),!0;default:return c({result:"unknown"}),!1}}),null===localStorage.getItem("enabled")&&enableAll(),"on"===getOption("contextmenu")&&chrome.contextMenus.create({title:chrome.i18n.getMessage("searchBili"),contexts:["selection"],onclick:searchBilibili}),checkDynamic(),window.navigator.userAgent.indexOf("Windows")<0&&checkSecurePlayer(),chrome.alarms.create("checkDynamic",{periodInMinutes:1}),"on"===getOption("versionNotify")&&chrome.alarms.create("checkVersion",{periodInMinutes:60}),chrome.runtime.onInstalled.addListener(function(a){setOption("version",chrome.runtime.getManifest().version),"install"===a.reason?chrome.tabs.create({url:chrome.extension.getURL("options.html?mod=install")}):"update"===a.reason&&compareVersion(getOption("version"),chrome.runtime.getManifest().version)<0&&chrome.notifications.create("bh-update",{type:"basic",iconUrl:"imgs/icon-256.png",title:chrome.i18n.getMessage("noticeficationTitle"),message:chrome.i18n.getMessage("noticeficationExtensionUpdate").replace("%v",chrome.runtime.getManifest().version),isClickable:!1,buttons:[{title:chrome.i18n.getMessage("noticeficationNewFeatures")}]},function(){})}),chrome.alarms.onAlarm.addListener(function(a){switch(a.name){case"checkDynamic":return checkDynamic(),!0;case"checkVersion":return updateNotified||checkVersion(),!0;case"getLocale":return localeAcquired||clearTimeout(localeTimeout),!0;default:return!1}}),chrome.notifications.onButtonClicked.addListener(function(a,b){void 0!==Live.tvNotification[a]&&chrome.tabs.create({url:protocol+"live.bilibili.com"+subName+a}),void 0!==Live.notisesIdList[a]?0===b?chrome.tabs.create({url:Live.notisesIdList[a].link}):1===b&&chrome.tabs.create({url:protocol+"live.bilibili.com/i/following"}):"bh-update"===a?chrome.tabs.create({url:chrome.extension.getURL("options.html?mod=update")}):"getTV"===a?chrome.tabs.create({url:protocol+"live.bilibili.com/i/awards"}):0===b&&notificationAvid[a]?chrome.tabs.create({url:protocol+"www.bilibili.com/video/av"+notificationAvid[a]}):1===b&&notificationAvid[a]&&resetVideoHostList()}),chrome.webRequest.onBeforeRequest.addListener(function(a){chrome.tabs.sendMessage(a.tabId,{command:"error"})},{urls:["https://comment.bilibili.com/1272.xml"]}),chrome.webRequest.onBeforeSendHeaders.addListener(function(a){if(a.tabId in biliTabs){var b=_.find(a.requestHeaders,function(a){return"referer"===a.name.toLowerCase()});b&&b.value&&(refererList[a.url]=b.value)}else refererList[a.url]&&a.requestHeaders.push({name:"Referer",value:refererList[a.url]});return{requestHeaders:a.requestHeaders}},{urls:PLAY_URLS},["blocking","requestHeaders"]),chrome.webRequest.onResponseStarted.addListener(function(a){if(!(a.tabId<0)){var b=/cid=([\d]+)/,c=b.exec(a.url),d=void 0;if(c&&c[1]){var e=_.filter(biliTabs,function(a,b){return a==c[1]});if(e&&e.length>0&&parsedDataList[c[1]])return void chrome.tabs.sendMessage(a.tabId,{command:"playurl",url:a.url,data:parsedDataList[c[1]]})}biliTabs[a.tabId]&&a.url.indexOf("cid="+biliTabs[a.tabId])<0||(c&&c[1]&&(d=c[1]),getFileData(a.url,function(b){var c={};if(b.startsWith("<")){var e=new DOMParser,f=e.parseFromString(b,"text/xml"),g=function h(a){var b={},c=!0,d=!1,e=void 0;try{for(var f,g=a[Symbol.iterator]();!(c=(f=g.next()).done);c=!0){var i=f.value;if(i.nodeType!==Node.TEXT_NODE){var j=i.tagName,k=i.textContent;1===i.childNodes.length?isNaN(k)?"accept_quality"===j&&(k=k.split(",").map(Number)):k=Number(k):(k=h(i.childNodes),"backup_url"===j&&(k=k.url)),"undefined"==typeof b[j]?("durl"===j&&(b[j]=[k]),b[j]=k):b[j].constructor===Array?b[j].push(k):b[j]=[b[j],k]}}}catch(l){d=!0,e=l}finally{try{!c&&g["return"]&&g["return"]()}finally{if(d)throw e}}return b};c=g(f.documentElement.childNodes)}else c=JSON.parse(b);parsedDataList[d]=c,chrome.tabs.sendMessage(a.tabId,{command:"playurl",url:a.url,data:c})}))}},{urls:PLAY_URLS}),chrome.webRequest.onHeadersReceived.addListener(function(a){if(!(a.tabId<0)&&a.tabId in biliTabs){var b=a.responseHeaders,c=a.url.split("?")[0];return downloadNames[c]&&b.push({name:"Content-Disposition",value:"attachment; filename*=UTF-8''"+encodeURIComponent(downloadNames[c])}),{responseHeaders:b}}},{urls:["*://*.acgvideo.com/*"]},["responseHeaders","blocking"]),Live.notise={page:1,userMode:function(){return null!==DedeUserID},hasMore:!1,hasNew:!1,list:[],count:0,intervalNum:void 0,heart:{},roomIdList:{},cacheList:{},getList:function(a){var b=protocol+"api.live.bilibili.com/feed/v1/feed/getList?page="+Live.notise.page+"&page_size=10",c=function(b){var c={},d=[];if(each(b.data.list,function(a){c[b.data.list[a].room_id]=b.data.list[a]}),1===Live.notise.page?Live.notise.cacheList=c:each(c,function(a){Live.notise.cacheList[a]=c[a]}),Live.notise.hasMore=b.data.count>10&&10===b.data.list.length&&Live.notise.userMode()&&Live.notise.page*b.data.list.length<b.data.count,Live.notise.hasMore)Live.notise.page+=1,Live.notise.getList(a);else{for(var e in Live.notise.cacheList)void 0===Live.notise.roomIdList[e]&&d.push(Live.notise.cacheList[e]);d.length&&each(d,function(a){if(Live.favouritesIdList.indexOf(parseInt(d[a].room_id))!==-1){var b=d[a];chrome.notifications.create(String(b.room_id),{type:"basic",iconUrl:b.face,title:b.nickname+chrome.i18n.getMessage("notificationLiveOn"),message:b.roomname,isClickable:!0,buttons:[{title:chrome.i18n.getMessage("notificationWatch")}]},function(a){Live.notisesIdList[a]=b,setTimeout(function(){chrome.notifications.clear(a),delete Live.notisesIdList[a]},1e4)})}}),Live.notise.roomIdList=Live.notise.cacheList,Live.notise.cacheList={}}},d=Live.notise.userMode()?"POST":"GET";getFileData(b,c,d,"json")},heartBeat:function(a){getFileData(protocol+"api.live.bilibili.com/feed/v1/feed/heartBeat",function(b){b=JSON.parse(b),Live.notise["do"](b),a instanceof Function&&a(b)},"POST")},"do":function(a){a.data&&(Live.notise.feedMode=a.data.open,0===a.code?(Live.notise.count=a.data.count,(a.data.open&&!a.data.has_new&&a.data.has_new!==Live.notise.hasNew||a.data.open&&a.data.has_new)&&(Live.notise.hasNew=a.data.has_new,Live.notise.count=0,Live.notise.page=1,Live.notise.open=!0,Live.notise.getList(a.data))):clearInterval(Live.notise.intervalNum))},init:function(){Live.notise.count=0,Live.notise.hasMore=!1,Live.notise.list=[],Live.notise.count=0,Live.notise.intervalNum=void 0,Live.notise.heart={},Live.notise.roomIdList={},Live.notise.cacheList={},Live.notise.heartBeat(),Live.notise.getList(),Live.notise.intervalNum=setInterval(function(){Live.notise.heartBeat(function(){Live.notise.hasMore&&(Live.notise.page++,Live.notise.getList())})},3e4)}},"on"===getOption("liveNotification")&&chrome.cookies.get({url:"https://live.bilibili.com",name:"DedeUserID"},function(a){a&&(DedeUserID=a.value,Live.notise.init())}),chrome.runtime.onConnect.addListener(function(a){a.onMessage.addListener(function(a){if(!a.cmd)return!1})});